{"ts":1378938236268,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"<?php\n\n/**\n * This class contains the functions for registering, associating and determining barcodes\n * @author Sean Burke, http://www.seantburke.com\n *\n */\n\nclass Barcode{\n\n\tpublic $db;\n\tpublic $code;\n\tpublic $error;\n\tpublic $login;\n\tpublic $REGEX = \"/^[E|S|C|A|N][0-9]{5,5}$/\";\n\tpublic $BARCODE_LENGTH = 6;\t\t//These need to be changed to validate different types of barcodes, this length is 6\n\tpublic $PREFIX = 'E';\t\t\t//This is the prefix that will validate the barcode\n\n\tfunction __construct($code){\n\t\t$this->code = $code;\n\t\t$this->db = new DB();\n\t\t$this->login = new Login();\n\t}\n\t\n\tfunction isEmpty()\n\t{\n\t\treturn $this->code == '';\n\t}\n\t\n\tfunction checkForRegistration($ucinetid){\n\t\t$temp = false;\n\t\tif($this->validate())\n\t\t{\n\t\t\tif($this->exists())\n\t\t\t{\n\t\t\t\tif($this->isNonAssociated($ucinetid))\n\t\t\t\t{\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$this->error = 'Invalid Barcode <strong>#'.$this->code.'</strong>';\n\t\t\treturn false;\n\t\t}\n\t\treturn ($this->validate()) && ($this->exists()) && ($this->isNonAssociated($ucinetid));\n\t}\n\t\n\t/**\n\t * determine whether a barcode exists or not\n\t * @param string $barcode\n\t * @return boolean\n\t */\n\tfunction validate2(){\n\t\tif(strlen($this->code) != $this->BARCODE_LENGTH)\n\t\t{\n\t\t\t//echo 'Strlen('.strlen($this->code).')';\n\t\t\t$this->error = 'Barcode <strong>'.$this->code.'</strong> must be of length: '.$this->BARCODE_LENGTH;\n\t\t\treturn false;\n\t\t}\n\t\t$pos = strpos($this->code, $this->PREFIX);\n\t\t\n\t\tif ($pos === false) {\n\t\t    $this->error = 'The prefix <strong>'.$this->PREFIX.'</strong> was not found in the barcode <strong>'.$this->code.'</strong>';\n\t\t    return false;\n\t\t} \n\t\t\n\t\tif ($pos !== 0) {\n\t\t    $this->error = 'The prefix of <strong>'.$this->code.'</strong> is not valid';\n\t\t    return false;\n\t\t}\n\t\treturn true;\n\t}\n\t\n\tfunction validate(){\n\t\t$value = preg_match($this->REGEX, $this->code);\n\t\tif($value != 1)\n\t\t{\n\t\t\t$this->error = 'The barcode <strong>'.$this->code.'</strong> is not valid';\n\t\t}\n\t\treturn $value;\n\t}\n\n\t/**\n\t * determine whether a barcode exists or not\n\t * @param string $barcode\n\t * @return boolean\n\t */\n\tfunction exists(){\n\t\t$sql = 'SELECT * FROM barcodes\n\t\t\t\tWHERE barcode = \"'.$this->code.'\"';\n\t\t$this->db->query($sql);\n\t\tif(!$this->db->isEmpty())\n\t\t{\n\t\t\treturn true;\n\t\t}\n\t\telse\n\t\t{\n\t\t\t$this->error = 'The barcode <strong>'.$this->code.'</strong> was not properly pre-registered. Please put this wristband aside, and distribute a new one.';\n\t\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Register a barcode into the MySQL Table: barcodes\n\t * @param string $barcode\n\t * @return boolean\n\t */\n\t\n\tfunction register()\n\t{\t\n\t\t//echo 'Registering...';\n\t\tif($this->validate())\n\t\t{\n\t\t\t//echo 'Validating...';\n\t\t\tif(!$this->isEmpty())\n\t\t\t{\n\t\t\t\tif(!$this->exists())\n\t\t\t\t{\n\t\t\t\t\t$sql = 'INSERT INTO barcodes\n\t\t\t\t\t\t\tSET barcode = \"'.$this->code.'\",\n\t\t\t\t\t\t\tdate = \"'.NOW_DATE.'\",\n\t\t\t\t\t\t\ttime = \"'.NOW_TIME.'\",\n\t\t\t\t\t\t\tvolunteer = \"'.$_SESSION['ucinetid'].'\"';\n\t\t\t\t\t$this->db->execute($sql);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\telse \n\t\t\t\t{\n\t\t\t\t\t$this->error = 'The barcode <strong>'.$this->code.'</strong> is already registered';\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\telse {\n\t\t\t\t$this->error = 'There is no Barcode';\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\t\telse\n\t\t{\n\t\t\treturn false;\n\t\t}\n\t}\n\n\tfunction isNonAssociated($current_user = '')\n\t{\n\t\t$sql = 'SELECT ucinetid\n\t\t\t\tFROM users\n\t\t\t\tWHERE barcode = \"'.$this->code.'\"';\n\t\t$this->db->query($sql);\n\t\t$user = $this->db->resultToSingleArray();\n\t\t\n\t\tif($this->db->isEmpty())\n\t\t{\n\t\treturn true;\n\t\t}\n\t\telseif($current_user == $user['ucinetid'])\n\t\t{\n\t\treturn true;\n\t\t}\n\t\telse\n\t\t{\n\t\t$this->error = 'The barcode <strong>#'.$this->code.'</strong> is already associated with <strong>'.$user['ucinetid'].'</strong>';\n\t\treturn false;\n\t\t}\n\t}\n\n\t/**\n\t * Associate a barcode with a user\n\t * @param string $barcode\n\t * @param string $ucinetid\n\t * @return boolean\n\t */\n\tfunction associate($ucinetid)\n\t{\n\t\tif($this->exists())\n\t\t{\n\t\t\tif($this->isNonAssociated($ucinetid))\n\t\t\t{\n\t\t\t\tif($this->login->exists($ucinetid))\n\t\t\t\t{\n\t\t\t\t\t$sql = 'UPDATE barcodes\n\t\t\t\t\t\tSET ucinetid = \"\"\n\t\t\t\t\t\tWHERE ucinetid = \"'.$ucinetid.'\"';\n\t\t\t\t\t$this->db->query($sql);\n\t\t\t\t\t\n\t\t\t\t\t$sql = 'UPDATE barcodes\n\t\t\t\t\t\tSET ucinetid = \"'.$ucinetid.'\"\n\t\t\t\t\t\tWHERE barcode = \"'.$this->code.'\"';\n\t\t\t\t\t$this->db->query($sql);\n\n\t\t\t\t\t$sql = 'UPDATE users\n\t\t\t\t\t\tSET barcode = \"'.$this->code.'\"\n\t\t\t\t\t\tWHERE ucinetid = \"'.$ucinetid.'\"';\n\t\t\t\t\t$this->db->query($sql);\n\t\t\t\t\treturn true;\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\t$this->error = 'Login <strong>'.$ucinetid.'</strong> does not exist';\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t$this->error = 'This is already associated';\n\t\t\t}\n\t\t\treturn false;\n\t\t}\n\t\t$this->error = 'Barcode does not exist';\n\t\treturn false;\n\t}\n\t\n\tfunction unassociate($ucinetid)\n\t{\n\t\tif($this->login->exists($ucinetid))\n\t\t{\n\t\t\t$sql = 'UPDATE barcodes\n\t\t\t\tSET ucinetid = \"\"\n\t\t\t\tWHERE ucinetid = \"'.$ucinetid.'\"';\n\t\t\t$this->db->query($sql);\n\n\t\t\t$sql = 'UPDATE users\n\t\t\t\tSET barcode = \"\"\n\t\t\t\tWHERE ucinetid = \"'.$ucinetid.'\"';\n\t\t\t$this->db->query($sql);\n\t\t\treturn true;\n\t\t}\n\t\telse\n\t\t{\n\t\t\treturn false;\n\t\t}\n\t\t$this->error = 'Login <strong>'.$ucinetid.'</strong> does not exist';\n\t\treturn false;\n\t}\n\n\t/**\n\t * Enter description here ...\n\t * @param string $barcode\n\t * @return Array $userArray\n\t */\n\tfunction getUserArray($code)\n\t{\n\t\t$sql = 'SELECT *\n\t\t\t\tFROM users\n\t\t\t\tWHERE barcode = \"'.$code.'\"';\n\n\t\t$this->db->query($sql);\n\t\t$userArray = $this->db->resultToSingleArray();\n\t\tif($this->db->isEmpty())\n\t\t{\n\t\t\t$this->error = 'The barcode <strong>'.$this->barcode.'</strong> is not associated with a UCInetID';\n\t\t\treturn false;\n\t\t}\n\t\telse\n\t\t{\n\t\t\treturn $userArray;\n\t\t}\n\t}\n\t\n\tfunction getUCInetID()\n\t{\n\t\t$sql = 'SELECT b.ucinetid\n\t\t\t\tFROM barcodes as b\n\t\t\t\tWHERE barcode = \"'.$this->code.'\"';\n\t\n\t\t$this->db->query($sql);\n\t\t$result = $this->db->resultToSingleArray();\n\t\tif($this->db->isEmpty())\n\t\t{\n\t\t\t$this->error = 'The barcode <strong>'.$this->barcode.'</strong> is not associated with a UCInetID';\n\t\t\treturn false;\n\t\t}\n\t\telse\n\t\t{\n\t\t\treturn $result['ucinetid'];\n\t\t}\n\t}\n\t\n\tfunction getName()\n\t{\n\t\t$sql = 'SELECT name\n\t\t\t\tFROM users\n\t\t\t\tWHERE barcode = \"'.$this->code.'\"';\n\t\n\t\t$this->db->query($sql);\n\t\t$result = $this->db->resultToSingleArray();\n\t\tif($this->db->isEmpty())\n\t\t{\n\t\t\t$this->error = 'The <strong>'.$this->barcode.'</strong> is not associated with a UCInetID';\n\t\t\treturn false;\n\t\t}\n\t\telse\n\t\t{\n\t\t\treturn $result['name'];\n\t\t}\n\t}\n\n\n\n}\n\n\n?>"]],"start1":0,"start2":0,"length1":0,"length2":6429}]],"length":6429}
