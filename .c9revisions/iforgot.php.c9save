{"ts":1378760322614,"silentsave":true,"restoring":false,"patch":[[{"diffs":[[1,"<?php\nrequire_once 'inc/standard.php';\n\n$page = new Page('iforgot', ALL);\n\n$page->setTitle('Forgot Password');\n\n//clean each $_POST value of dangerous inputs\n//example $newsettings['email'] = 'stburke@uci.edu';\nforeach ($_POST as $key => $value) {\n\t//echo '$newsettings[\\''.$key.'\\'] = '.$value.';<br>';\n\t$iforgot[$key] = trim(strip_tags($value));\n}\n\n$login = new Login();\n$ucinetid = ($_POST['ucinetid'])? $_POST['ucinetid']:$_GET['ucinetid'];\n$person = new UCIPerson($ucinetid);\n$ucinetid = $person->ucinetid;\n\nif($_POST['action'] == 'resetlogin')\n{\n\t$errors=1;\n\tif(!($login->exists($ucinetid)))\n\t{\n\t\t$errors++;\n\t\t$error_message = $login->error;\n\t}\n\n\tif($errors == 1)\n\t{\n\t\t$secret = substr(base64_encode(crypt('', '')), 0, 32);\n\n\n\t\t$sql = 'SELECT l.*, u.*\n\t\t\t\tFROM users AS u, logon AS l\n\t\t \t\tWHERE u.ucinetid = \"'.$ucinetid.'\"\n\t\t \t\tLIMIT 1';\n\t\t$page->DB->query($sql);\n\t\t$user = $page->DB->resultToSingleArray();\n\n\t\t$sql = \"REPLACE INTO reset (ucinetid, secret, date)\n\t\t\t\tVALUES ('$ucinetid', '$secret', NOW())\";\n\t\t$result = $page->DB->query($sql);\n\n\t\t$message = 'An email was sent to <a href=\"https://webmail.uci.edu/rcm/?_user='.$ucinetid.'\">'.$user['email'].'</a> with instructions on how to reset your password. Visit <a href=\"https://webmail.uci.edu/rcm/?_user='.$ucinetid.'\">WebMail</a>';\n\t\t$page->setMessage($message, 'success');\n\t\t//mail;\n\t\t$link = WEBSITE.'/recover.php?ucinetid='.$ucinetid.'&secret='.$secret;\n\t\t$to = $user['email'];\n\t\t$subject = 'Forgot your password?';\n\t\t$body = ' <p>Hi '.$user['name'].', </p>\n\t\t\t\t<p>A request to reset you password has been made. If you did not initiate this reset, please ignore this email.</p>\n\t\t\t\t<br>\n\t\t\t\t<p>To reset you password please follow the link provided, or copy and paste the following link into your browser:</p>\n\t\t\t\t<strong><a href=\"'.$link.'\">'.$link.'</a></strong>';\n\t\t$mail = new Mail($to, $subject, $body);\n\t\t$mail->send();\n\t\t$page->login->logout();\n\t}\n\telse\n\t{\n\t\t$page->setMessage($error_message, 'failure');\n\t}\n}\n\n$bottom = $login->resetForm('resetform','resetform','iforgot.php', $ucinetid);\n\n$box = new Box('Forgot Password?', $bottom);\n\n$box->setBadge('Register', 'register.php?ucinetid='.$ucinetid);\n\n$page->setContent($box->display('half'));\n$page->buildPage();"]],"start1":0,"start2":0,"length1":0,"length2":2237}]],"length":2237}
